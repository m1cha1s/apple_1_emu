#include "apple_1_emu.h"

#if _WIN32
#include <io.h>
#endif

#include <stdio.h>
#include <stdint.h>
#include <ctype.h>
#include <memory.h>

void reset6502();
void exec6502(uint32_t tickcount);
void step6502();                
void irq6502();
void nmi6502();
void hookexternal(void *funcptr);

extern uint8_t readkey();
extern void writechar(uint8_t ch);
extern uint8_t keyavailable();

#define MEM_SIZE 0x8000

uint8_t memory[MEM_SIZE];

const unsigned char wozmon[256] = {
    0xD8, 0x58, 0xA0, 0x7F, 0x8C, 0x12, 0xD0, 0xA9, 
    0xA7, 0x8D, 0x11, 0xD0, 0x8D, 0x13, 0xD0, 0xC9, 
    0xDF, 0xF0, 0x13, 0xC9, 0x9B, 0xF0, 0x03, 0xC8, 
    0x10, 0x0F, 0xA9, 0xDC, 0x20, 0xEF, 0xFF, 0xA9, 
    0x8D, 0x20, 0xEF, 0xFF, 0xA0, 0x01, 0x88, 0x30, 
    0xF6, 0xAD, 0x11, 0xD0, 0x10, 0xFB, 0xAD, 0x10, 
    0xD0, 0x99, 0x00, 0x02, 0x20, 0xEF, 0xFF, 0xC9, 
    0x8D, 0xD0, 0xD4, 0xA0, 0xFF, 0xA9, 0x00, 0xAA, 
    0x0A, 0x85, 0x2B, 0xC8, 0xB9, 0x00, 0x02, 0xC9, 
    0x8D, 0xF0, 0xD4, 0xC9, 0xAE, 0x90, 0xF4, 0xF0, 
    0xF0, 0xC9, 0xBA, 0xF0, 0xEB, 0xC9, 0xD2, 0xF0, 
    0x3B, 0x86, 0x28, 0x86, 0x29, 0x84, 0x2A, 0xB9, 
    0x00, 0x02, 0x49, 0xB0, 0xC9, 0x0A, 0x90, 0x06, 
    0x69, 0x88, 0xC9, 0xFA, 0x90, 0x11, 0x0A, 0x0A, 
    0x0A, 0x0A, 0xA2, 0x04, 0x0A, 0x26, 0x28, 0x26, 
    0x29, 0xCA, 0xD0, 0xF8, 0xC8, 0xD0, 0xE0, 0xC4, 
    0x2A, 0xF0, 0x97, 0x24, 0x2B, 0x50, 0x10, 0xA5, 
    0x28, 0x81, 0x26, 0xE6, 0x26, 0xD0, 0xB5, 0xE6, 
    0x27, 0x4C, 0x44, 0xFF, 0x6C, 0x24, 0x00, 0x30, 
    0x2B, 0xA2, 0x02, 0xB5, 0x27, 0x95, 0x25, 0x95, 
    0x23, 0xCA, 0xD0, 0xF7, 0xD0, 0x14, 0xA9, 0x8D, 
    0x20, 0xEF, 0xFF, 0xA5, 0x25, 0x20, 0xDC, 0xFF, 
    0xA5, 0x24, 0x20, 0xDC, 0xFF, 0xA9, 0xBA, 0x20, 
    0xEF, 0xFF, 0xA9, 0xA0, 0x20, 0xEF, 0xFF, 0xA1, 
    0x24, 0x20, 0xDC, 0xFF, 0x86, 0x2B, 0xA5, 0x24, 
    0xC5, 0x28, 0xA5, 0x25, 0xE5, 0x29, 0xB0, 0xC1, 
    0xE6, 0x24, 0xD0, 0x02, 0xE6, 0x25, 0xA5, 0x24, 
    0x29, 0x07, 0x10, 0xC8, 0x48, 0x4A, 0x4A, 0x4A, 
    0x4A, 0x20, 0xE5, 0xFF, 0x68, 0x29, 0x0F, 0x09, 
    0xB0, 0xC9, 0xBA, 0x90, 0x02, 0x69, 0x06, 0x2C, 
    0x12, 0xD0, 0x30, 0xFB, 0x8D, 0x12, 0xD0, 0x60, 
    0x00, 0x00, 0x00, 0x0F, 0x00, 0xFF, 0x00, 0x00, 
};

uint8_t read6502(uint16_t address) {
	if (address < MEM_SIZE)
		return memory[address]; // Ram
	if (address == 0xD010) {
		uint8_t c = toupper(readkey());
		if (c == 10)
			c = 13;
		c |= 0x80;
		return c; // Give the character
	}
	if (address == 0xD011) {
		char b;
        if(keyavailable())
			return 0x80; // Characters available
		else
			return 0;    // No characters available
	}
	if (address == 0xD012)
		return 0; // We are ready to print the character
	if (address >= 0xFF00)
		return wozmon[address-0xFF00];

	return 0;
}

void write6502(uint16_t address, uint8_t value) {
	if (address < MEM_SIZE)
		memory[address] = value;
	if (address == 0xD012) {
		uint8_t temp8 = value & 0x7F;
		if (temp8 == 13)
			temp8 = 10;
		writechar(temp8);
	}
}

void apple_1_init() {
    reset6502();
}

void apple_1_step() {
	step6502();
}
